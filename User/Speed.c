#include "include.h"
#include "LQ_MOTOR.h"
#include "Speed.h"
#include "Param.h"
/**********??????????********/
int32 LeftDead = 0;  //???????? 10-15%
int32 RighDead = 0;  //????????
int32 g_nLeftpulse = 0, g_nRighpulse = 0;
//float Ratio_Encoder_Left = 207/(512*0.02);// 左轮速度=counter*左轮周长(mm)/(左轮转一圈对应的脉冲数*程序周期)
//float Ratio_Encoder_Righ = 207/(512*0.02);// 右轮速度=counter*右轮周长(mm)/(右轮转一圈对应的脉冲数*程序周期)
float g_fRealSpeed = 0;		//??????
float g_fLeftRealSpeed;
float g_fRighRealSpeed;
float g_fSpeedFilter = 0;		//??????????

float g_fExpectSpeed = 500;		//期望值（待定）max==3500
float g_fSpeedError;			//??????

int32 LeftPWM=0, RightPWM=0;  //
int32 LeftPWM_F= 0, RighPWM_F= 0;  //??????????PWM???

float bangbangValue = 500;            //????С????????
float SpeedPwm = 0;    //?????????pwm
float oriSpeedPwm; //????????? origional pwm
speedPID  s_pid;

extern Param param;
/*float g_fSpeedErrorTemp[5] = {0};
float fSpeedErrorInteg = 0;			

float g_PWMOut;

//??????
float Kp=320;		//???P
float Ki=100;		//???I
float Kd=100;
float g_fSpeedControlOut=0;		//??????	
*/
/*------------------------------------------------------------------------------------------------------
????    ????PWMOut
????    ???FTM0 ???PWM????????????
????    ??????
???? ?? ?????
???    ????pwminit????????????????????
?????????
--------------------------------------------------------------------------------------------------------*/
void PWMOut(void)
{
//      static u16 ms;
//	ms++;
//        if(ms>=s_pid.pwm_cycle ) {ms=0;}//????pwm???? ?0
//        if(ms>=s_pid.currpwm)
//	{
//	  pwmout_1 ;   //??
//	}
//	else
//	{
//	  pwmout_0;   //????
//	}
  
        //if(Flag_Speed == OFF)	g_fSpeedControlOut = 0;	//???Flag_Speed == OFF	 ????????
	//if(Flag_Direction == OFF)  DirectionOut = 0;	//???Flag_Direction == OFF ?????????		
         
        //起始的pwm为300
	DirectionPwm = 0;//调试速度pid
	LeftPWM = (int32)(300-DirectionPwm+SpeedPwm);  //????PWM==????-???
	RightPWM = (int32)(300+DirectionPwm+SpeedPwm); 
        
        abs(LeftPWM);//???
        LeftPWM_F = LeftDead + LeftPWM;
        LeftPWM_F = (LeftPWM_F > 950? 950: LeftPWM_F);
        FTM_PwmDuty(FTM0, FTM_CH0, 0);
        FTM_PwmDuty(FTM0, FTM_CH1, LeftPWM_F);
            
            
        abs(RightPWM);
        RighPWM_F = RighDead + RightPWM;
        RighPWM_F = (RighPWM_F > 950? 950: RighPWM_F);
        FTM_PwmDuty(FTM0, FTM_CH2, 0);
        FTM_PwmDuty(FTM0, FTM_CH3, RighPWM_F);
        
        param.LeftPWM_F = LeftPWM_F;
        param.RighPWM_F = RighPWM_F;
}


/*------------------------------------------------------------------------------------------------------
????    ????CalSpeedError
????    ?????????????
????    ??????
???? ?? ?????  g_fSpeedError
?????????
--------------------------------------------------------------------------------------------------------*/
void CalSpeedError(void)
{
	static float fSpeedOld = 0;
        static float fSpeedNew = 0;
        
	g_nLeftpulse = FTM_ABGet(FTM1);//(GPIO_PinRead(Coder_dir_left) ==1?FTM_ABGet(FTM1):-FTM_ABGet(FTM1));//???????????
	g_nRighpulse = FTM_ABGet(FTM2);//(GPIO_PinRead(Coder_dir_right)==0?FTM_ABGet(FTM2):-FTM_ABGet(FTM2));//???????????
	//不进行速度换算
	g_fLeftRealSpeed = g_nLeftpulse;//g_nLeftpulse*Ratio_Encoder_Left;
	g_fLeftRealSpeed = (g_fLeftRealSpeed>2000?2000:g_fLeftRealSpeed);		//???????????????
	g_fRighRealSpeed = g_nRighpulse;//g_nRighpulse*Ratio_Encoder_Righ;
	g_fRighRealSpeed = (g_fRighRealSpeed>2000?2000:g_fRighRealSpeed);		//???????????????
	
	g_fRealSpeed = (g_fLeftRealSpeed + g_fRighRealSpeed)*0.5;				//??????
	
	//???????????????β?????300  ??????????????????
	fSpeedOld = g_fSpeedFilter;
	fSpeedNew = g_fRealSpeed;
	
	if(fSpeedNew>=fSpeedOld)
		g_fSpeedFilter = ((fSpeedNew-fSpeedOld)>300?(fSpeedOld+300):fSpeedNew);
	else
		g_fSpeedFilter = ((fSpeedNew-fSpeedOld)<-300?(fSpeedOld-300):fSpeedNew);
	
        param.g_fSpeedFilter = g_fSpeedFilter;
	//flash?в???
//	g_fExpectSpeed = float05;  //2800
        
        //????????	
	g_fSpeedError =  g_fExpectSpeed - g_fSpeedFilter;
/*	g_fSpeedErrorTemp[4] = g_fSpeedErrorTemp[3];
	g_fSpeedErrorTemp[3] = g_fSpeedErrorTemp[2];
	g_fSpeedErrorTemp[2] = g_fSpeedErrorTemp[1];
	g_fSpeedErrorTemp[1] = g_fSpeedErrorTemp[0];
	g_fSpeedErrorTemp[0] = g_fSpeedError;
*/	
}

/*------------------------------------------------------------------------------------------------------
????    ????SpeeedPID_Init
????    ??????pid???????
????    ??????
???? ?? ?????
?????????
--------------------------------------------------------------------------------------------------------*/
void SpeeedPID_Init()  
{
  
  s_pid.set =g_fExpectSpeed;
  s_pid.currpwm=0;
  s_pid.pwm_cycle=100;    
  s_pid.calc_cycle=100; //? 
  s_pid.Td=2000;
  s_pid.Ti=4000;
  s_pid.Kp=5;
  s_pid.Tsam=20;//20ms  s_pid
  s_pid.En=0;
  s_pid.En_1=0;
  s_pid.En_2=0;
  
  param.g_fExpectSpeed = g_fExpectSpeed;

}

/*------------------------------------------------------------------------------------------------------
????    ????CalSpeedPID
????    ??????????pid ???oriSpeedPwm
????    ??????
???? ?? ?????  oriSpeedPwm
??????????????pid δ?????? ????δ????
--------------------------------------------------------------------------------------------------------*/
void CalSpeedPID(void)
{

  float dk1;float dk2;
  float t1,t2,t3;
	
          CalSpeedError();
          
//	if(pidcalcms<pid.Tsam) return ;  //
	//pid.En=pid.set-pid.curr;  //???????
	s_pid.En = g_fSpeedError;
          dk1=s_pid.En-s_pid.En_1;   //??????????????????
	dk2=s_pid.En-2*s_pid.En_1+s_pid.En_2;
	
          t1=s_pid.Kp*dk1;
	
	t2=(s_pid.Kp*s_pid.Tsam)/s_pid.Ti;
	t2=t2*s_pid.En;
	
	t3=(s_pid.Kp*s_pid.Td)/s_pid.Tsam;
	t3=t3*dk2;
	
         s_pid.Dout=t1+t2+t3;  //????????????????
	s_pid.currpwm+=s_pid.Dout;  //????????????PWM
	if(s_pid.currpwm>s_pid.pwm_cycle) {s_pid.currpwm=s_pid.pwm_cycle;}//??????
	if(s_pid.currpwm<0) {s_pid.currpwm=0;}
	
        oriSpeedPwm=s_pid.currpwm;//????????????PWM  ???
          s_pid.En_2=s_pid.En_1;
          s_pid.En_1=s_pid.En;
	//s_pidcalcms=0;
}


/*------------------------------------------------------------------------------------------------------
????    ????SpeedPartitionPwmOut
????    ?????????pwm???  bangbang??
????    ??????
???? ?? ?????  SpeedPwm
??????????????pid δ?????? ????δ????
--------------------------------------------------------------------------------------------------------*/
void SpeedPartitionPwmOut()
{	
	CalSpeedPID();
	/*
	if (oriSpeedPwm < bangbangValue)
	{	
		SpeedPwm = 1000 ;//??????????pwmout?????
	}
	*/
	SpeedPwm = oriSpeedPwm;
        
        param.SpeedPwm = SpeedPwm;
}


/**
 * @file		??????
 * @note      	?????????
 * @date		2017
 */
/*
void SpeedControl(void){
//	int8 index=1;

	CalSpeedError();	//??????????
	g_fSpeedError = (g_fSpeedError>800?800:g_fSpeedError);//?????????
	//flash?в???
//	Kp = float06;	//320
//	Ki = float07;	//100	
	
//        //???????
//	if((g_fSpeedError<=300)&&(g_fSpeedError>=-300))
//	index=1;
//	else
//	index=0;	
//	fSpeedErrorInteg = index *float08 * g_fSpeedError * 0.00001;
	
//	if(Stop_Flag==OFF|Flag_Speed==OFF)
//	{
//		fSpeedErrorInteg = 0;	//???????????
//	}	
	//fSpeedErrorInteg = (fSpeedErrorInteg < 0.0? 0.0: fSpeedErrorInteg);//????????
	//fSpeedErrorInteg = (fSpeedErrorInteg > 400.0? 400.0: fSpeedErrorInteg);//????????
	
        //???????????????PI??
//	g_fSpeedControlOut += Kp*0.005*(g_fSpeedErrorTemp[0]-g_fSpeedErrorTemp[1]) + fSpeedErrorInteg;
//	g_fSpeedControlOut = (g_fSpeedControlOut>=6000?6000:g_fSpeedControlOut);
	//?????PID
        g_fSpeedControlOut = Kp*(g_fSpeedErrorTemp[0]-g_fSpeedErrorTemp[1]) +Ki*g_fSpeedErrorTemp[0]+Kd*(g_fSpeedErrorTemp[0]-2*g_fSpeedErrorTemp[1]+g_fSpeedErrorTemp[2]);
        g_fSpeedControlOut = (g_fSpeedControlOut>=6000?6000:g_fSpeedControlOut);
        //С????С??????????????pwm????
        g_fSpeedControlOut = (g_fSpeedControlOut<= bangbang_value? 6000:g_fSpeedControlOut);
         
          
          
}

*/


